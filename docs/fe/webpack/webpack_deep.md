# webpack æ·±å…¥å­¦ä¹ 

## webpack ä¸å…¶å®ƒæ‰“åŒ…å·¥å…·çš„ä¸åŒ

åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ JavaScript æœ‰ä¸¤ç§æ–¹æ³•ã€‚

ç¬¬ä¸€ç§æ–¹å¼ï¼Œå¼•ç”¨ä¸€äº›è„šæœ¬æ¥å­˜æ”¾æ¯ä¸ªåŠŸèƒ½ã€‚è¿™ç§æ–¹æ¡ˆå¾ˆéš¾æ‰©å±•ï¼Œå› ä¸ºåŠ è½½å¤ªå¤šè„šæœ¬ä¼šå¯¼è‡´ç½‘ç»œç“¶é¢ˆã€‚

ç¬¬äºŒç§æ–¹å¼ï¼Œä½¿ç”¨ä¸€ä¸ªåŒ…å«æ‰€æœ‰é¡¹ç›®ä»£ç çš„å¤§å‹ js æ–‡ä»¶ï¼Œä½†è¿™ä¼šå¯¼è‡´ä½œç”¨åŸŸã€æ–‡ä»¶å¤§å°ã€å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§æ–¹é¢çš„é—®é¢˜ã€‚

ç«‹å³è°ƒç”¨å‡½æ•°è¡¨è¾¾å¼ï¼ˆIIFEï¼‰çš„å‡ºç°è§£å†³äº†å¤§å‹é¡¹ç›®çš„ä½œç”¨åŸŸé—®é¢˜ã€‚å½“è„šæœ¬æ–‡ä»¶è¢«å°è£…åœ¨ IIFE å†…éƒ¨æ—¶ï¼Œå¯ä»¥å®‰å…¨åœ°æ‹¼æ¥æˆ–å®‰å…¨åœ°ç»„åˆæ‰€æœ‰æ–‡ä»¶ï¼Œè€Œä¸å¿…æ‹…å¿ƒä½œç”¨åŸŸå†²çªã€‚å› æ­¤è¯ç”Ÿäº†ä¸€æ‰¹ Gulpã€Grunt ç­‰ä»»åŠ¡æ‰§è¡Œå™¨ã€‚

ä½†æ˜¯è¿™æ ·ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶æ„å‘³ç€å¿…é¡»é‡æ–°æ„å»ºæ•´ä¸ªæ–‡ä»¶ï¼Œæ‹¼æ¥å¯ä»¥åšåˆ°å®¹æ˜“åœ°è·¨æ–‡ä»¶é‡ç”¨è„šæœ¬ï¼Œä½†å´ä½¿æ„å»ºç»“æœçš„ä¼˜åŒ–å˜å¾—æ›´åŠ å›°éš¾ã€‚å¦‚ä½•åˆ¤æ–­ä»£ç æ˜¯å¦å®é™…è¢«ä½¿ç”¨ï¼Ÿå³ä½¿ä½ åªç”¨åˆ° loadash ä¸­çš„æŸä¸ªå‡½æ•°ï¼Œä¹Ÿå¿…é¡»åœ¨æ„å»ºç»“æœä¸­åŠ å…¥æ•´ä¸ªåº“ï¼Œæ¥ç€å°†å®ƒä»¬å‹ç¼©åˆ°ä¸€èµ·ã€‚å¦‚ä½• treeshake ä»£ç ä¾èµ–ï¼Ÿéš¾ä»¥å¤§è§„æ¨¡åœ°å®ç°å»¶è¿ŸåŠ è½½ä»£ç å—ï¼Œè¿™éœ€è¦å¼€å‘äººå‘˜æ‰‹åŠ¨åœ°è¿›è¡Œå¤§é‡å·¥ä½œã€‚

[ä¸ºä»€ä¹ˆé€‰æ‹©webpack](https://webpack.docschina.org/concepts/why-webpack/){link=card}

## webapck å·¥ä½œåŸç†

é€šè¿‡ `fs.readFileSync` è¯»å–å…¥å£æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ `@bable/parser` è·å– ast æŠ½è±¡è¯­æ³•æ ‘ï¼Œå€ŸåŠ© `@babel/core` å’Œ `@babel/preset-env`ï¼ŒæŠŠ ast è¯­æ³•æ ‘è½¬æ¢æˆåˆé€‚çš„ä»£ç ï¼Œæœ€åè¾“å‡ºä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ã€‚

å®ƒä¼šä»¥ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ä½œä¸ºæ‰“åŒ…çš„å…¥å£ï¼Œåœ¨ webpack å¤„ç†ä¸åŒæ¨¡å—ä¾èµ–æ—¶ï¼Œä¼šå°†ä»£ç åˆ†å‰²æˆå¤šä¸ª chunkï¼Œæ¯ä¸ª chunk åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—ï¼Œæœ€åå°†æ•´ä¸ªé¡¹ç›®æ‰€æœ‰æ–‡ä»¶ç¼–è¯‘ç»„åˆæˆä¸€ä¸ªæˆ–å¤šä¸ª bundle è¾“å‡ºå‡ºå»ã€‚

ä¸€ä¸ª bundle å¯ä»¥åŒ…å«å¤šä¸ª chunkï¼Œä¹Ÿå¯ä»¥åªåŒ…å«ä¸€ä¸ª chunkã€‚

## chunk

chunk ä»£ç å—ï¼Œæ˜¯ webpack æ ¹æ®åŠŸèƒ½æ‹†åˆ†å‡ºæ¥çš„ã€‚webpack åœ¨å¤„ç†æ¨¡å—ä¾èµ–å…³ç³»æ—¶ï¼Œä¼šå°†ä»£ç åˆ†å‰²æˆå¤šä¸ª chunkï¼Œæ¯ä¸ª chunk åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—ã€‚

chunk çš„ç”Ÿæˆæ˜¯ç”± webpack çš„ä»£ç åˆ†å‰²åŠŸèƒ½å®ç°çš„ï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®æˆ–è‡ªåŠ¨åˆ†å‰²ã€‚chunk æ˜¯ webpack çš„å†…éƒ¨æ¦‚å¿µï¼Œä¸ä¼šç›´æ¥è¾“å‡ºåˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œwebpack ä¼šåœ¨ dist è¾“å‡º chunk ç”Ÿæˆçš„ bundleï¼Œæ–‡ä»¶åå°±æ˜¯ chunk åç§°ã€‚è¯¥åç§°æœ€ç»ˆä¼šä½“ç°åœ¨ bundle çš„å‘½åä¸Šï¼Œæœ€ç»ˆéšç€ bundle è¾“å‡ºã€‚

### entry ç”Ÿæˆ chunk

output.filename é…ç½®è¾“å‡º chunk åå­—ã€‚

### æŒ‰éœ€åŠ è½½ï¼ˆå¼‚æ­¥ï¼‰äº§ç”Ÿçš„ chunk

æŒ‰éœ€åŠ è½½ï¼ˆå¼‚æ­¥ï¼‰çš„æ¨¡å—ä¹Ÿä¼šäº§ç”Ÿ chunkï¼Œè¿™ä¸ª chunk åç§°å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨ webpackChunkName è‡ªè¡Œå®šä¹‰ã€‚

å¦‚æœéœ€è¦æ‰“åŒ…æ—¶ä½¿ç”¨ chunk åç§°ï¼Œåˆ™éœ€è¦åœ¨ output.chunkFilename ä¸­å¼•ç”¨ã€‚

```js
module.exports = {
  output: { chunkFilename: "[name].js" },
}

import(/* webpackChunkName: "async-model" */ "./async-model");
```

### ä»£ç åˆ†å‰²äº§ç”Ÿçš„ chunk

åœ¨ webpack5 ä¸­ä»£ç åˆ†å‰²ä½¿ç”¨ SplitChunkPlugin æ’ä»¶å®ç°ï¼Œè¿™ä¸ªæ’ä»¶å†…ç½®åœ¨ webpack ä¸­ï¼Œä½¿ç”¨æ—¶ç›´æ¥ç”¨é…ç½®çš„æ–¹å¼å³å¯ã€‚

ä»£ç åˆ†å‰²æ—¶ä¹Ÿä¼šäº§ç”Ÿ chunkã€‚

```js
// webpack.config.js
module.exports = {
  entry: {
    index2: './src/index2.js',
    index3: './src/index3.js'
  },
  optimization: {
    // å–å€¼ 'multiple' æˆ– true éƒ½å¯ï¼Œæ ¹æ®å…¥å£äº§ç”Ÿå¤šä¸ªè¿è¡Œæ—¶chunk
    runtimeChunk: 'multiple',
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        vendor: {
          name: 'vendor',
          test: /node_modules/,
          priority: 10,
          reuseExistingChunk: true,
        },
        common: {
          name: 'common',
          minSize: 0,
          minChunks: 2,
          priority: -10,
          reuseExistingChunk: true
        }
      },
    }
  }
}

// index.js
console.log('ğŸ¥¬  ', 111);

// index2.js
import "./index";
import $ from 'jquery';
console.log('ğŸ¥¬ 222 ', $);

// index3.js
import "./index";
console.log('ğŸ¥¬ 333 ');
```

ä¸Šè¿°ä»£ç ï¼Œæ€»å…±ä¼šäº§ç”Ÿ 6 ä¸ªchunkã€‚

- ä¸¤ä¸ªå…¥å£åˆ†åˆ«åˆ†é…åˆ°åç§°ä¸º index2 å’Œ index3 çš„ chunk ä¸­ã€‚

- `runtimeChunk: 'multiple'` çš„å‡æ˜ï¼Œä¼šæŠ½ç¦» webpack è¿è¡Œæ—¶ä»£ç åˆ°å•ç‹¬çš„ chunk ä¸­ã€‚æœ‰ä¸¤ä¸ªå…¥å£ï¼Œå› æ­¤æœ‰ä¸¤ä»½è¿è¡Œæ—¶ chunkã€‚

- jquery ç¬¦åˆ cacheGroups.vendor è§„åˆ™ï¼ŒæŠ½ç¦»åˆ°åä¸º vendor çš„ chunk ä¸­ã€‚

- index.js ç¬¦åˆ cacheGroups.common è§„åˆ™ï¼ŒæŠ½ç¦»åˆ°åä¸º common çš„ chunk ä¸­ã€‚

![ä»£ç åˆ†å‰²äº§ç”Ÿchunk](./images/split-chunks.png)

## chunk å’Œ bundle çš„åŒºåˆ«

moduleã€chunkã€bundle å…¶å®å°±æ˜¯åŒä¸€ä»½ä»£ç ï¼Œåœ¨ä¸åŒè½¬æ¢åœºæ™¯ä¸‹çš„ä¸‰ä¸ªåç§°ã€‚

æˆ‘ä»¬ç›´æ¥å†™å‡ºæ¥çš„æ˜¯ moduleï¼Œwebpack å¤„ç†æ—¶æ˜¯ chunkï¼Œæœ€åç”Ÿæˆçš„æµè§ˆå™¨å¯ç›´æ¥è¿è¡Œçš„æ˜¯ bundleã€‚

![moduleã€chunkå’Œbundleçš„åŒºåˆ«](./images/module-chunk-bundle.png)

[webpackâ€”â€”moduleã€chunkå’Œbundleçš„åŒºåˆ«](https://blog.csdn.net/qq_17175013/article/details/119753186){link=card}

## filename & chunkFilename

é€šè¿‡ output çš„ filename å’Œ chunkFilename æ§åˆ¶ chunk è¾“å‡ºçš„ bundle å‘½åã€‚

[outputä¸­chunkFilenameå’Œfilenameçš„åŒºåˆ«](https://juejin.cn/post/6844904166150651917){link=card}

MiniCssExtractPlugin ä¹ŸåŒæ ·æœ‰è¿™äº›å­—æ®µï¼š

[Webpack - css æ–‡ä»¶çš„ä»£ç åˆ†å‰²](https://github.com/VenenoFSD/Learn-Webpack4/issues/17){link=card}

## å‘½å(hash)

webpack æ–‡ä»¶æ‰“åŒ…ä¸€èˆ¬æœ‰ä¸‰ç§ hashï¼šhashã€chunkhashã€contenthashã€‚

- hash æ˜¯é¡¹ç›®çº§åˆ«çš„ï¼Œä½¿ç”¨ hash çš„ç¼ºç‚¹æ˜¯ï¼ŒåŠ å…¥åªä¿®æ”¹äº†å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯æ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶åé‡Œçš„ hash éƒ½æ˜¯ç›¸åŒçš„ã€‚

- chunkhash æ ¹æ®ä¸åŒçš„å…¥å£æ–‡ä»¶(entry)è¿›è¡Œä¾èµ–æ–‡ä»¶è§£æï¼Œæ„å»ºå¯¹åº”çš„ chunkï¼Œç”Ÿæˆå¯¹åº”çš„å“ˆå¸Œå€¼ã€‚

- contenthash æ˜¯é’ˆå¯¹æ–‡ä»¶å†…å®¹çº§åˆ«çš„ï¼Œåªæœ‰è‡ªå·±æ¨¡å—çš„å†…å®¹æ”¹å˜ï¼Œå“ˆå¸Œå€¼æ‰ä¼šæ”¹å˜ã€‚

[ä»æºç çœ‹webpackçš„hashç­–ç•¥](https://juejin.cn/post/6844903942384517127){link=card}

[webpackä¸­æ–‡ä»¶æ‰“åŒ… hashã€chunkhashã€contenthash çš„åŒºåˆ«](https://juejin.cn/post/7078589390422802440){link=card}

å¯ä»¥ä½¿ç”¨ webpack æä¾›çš„æ¨¡æ¿å­—ç¬¦ä¸²å®šä¹‰ bundle æ–‡ä»¶åï¼Œä¸‹é¢æ˜¯å¸¸ç”¨çš„æ¨¡æ¿å­—ç¬¦ä¸²ã€‚

|æ¨¡æ¿|æè¿°|ç¨³å®šæ€§|
|--|--|--|
|[name]|chunk çš„åç§°|åªè¦chunkåç§°ä¸ä¿®æ”¹å°±ä¸ä¼šå˜åŒ–|
|[hash]|æ ¹æ®æ‰€æœ‰ chunk ç”Ÿæˆçš„ hash|å·¥ç¨‹æŸä¸ªchunkè¢«ä¿®æ”¹å°±ä¼šå¼•èµ·å˜åŒ–|
|[chunkhash]|æ ¹æ®chunkç”Ÿæˆçš„hashå€¼|æŸä¸ªchunkè¢«ä¿®æ”¹ï¼Œåªä¼šå¼•èµ·è¢«ä¿®æ”¹çš„chunkçš„hash|
|[contenthash]|æ ¹æ®bundleå†…å®¹ç”Ÿæˆçš„hash|chunkä¸­æŸä¸ªbundleè¢«ä¿®æ”¹ï¼Œåªä¼šå¼•èµ·è¢«ä¿®æ”¹çš„bundleçš„hash|

:::warning æ³¨æ„äº‹é¡¹
1. JS æ–‡ä»¶çš„æŒ‡çº¹è®¾ç½® `'[name][chunkhash:8].js'`ã€‚

JS æ–‡ä»¶ä¸ºä»€ä¹ˆä¸ç”¨ contenthashï¼Ÿ

å› ä¸º JS å¼•å…¥äº† css æ¨¡å—ï¼Œè‹¥ css æ”¹å˜ï¼Œcss ä½¿ç”¨çš„æ˜¯ contenthashï¼Œé‚£ä¹ˆ css çš„æŒ‡çº¹å˜äº†ã€‚ä½†å¯¹äºå¼•å…¥ css çš„ JS æ¨¡å—æ¥è¯´ï¼Œå®ƒçš„å†…å®¹æ˜¯æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„ã€‚

å› æ­¤å¦‚æœ js æ–‡ä»¶ä½¿ç”¨ contenthashï¼Œåˆ™ js æ¨¡å—çš„æŒ‡çº¹ä¸å˜ï¼Œå¯¼è‡´ js æ— æ³•å¼•å…¥æ›´æ–°åçš„ css æ–‡ä»¶ã€‚

2. css æ–‡ä»¶çš„æŒ‡çº¹è®¾ç½® `'[name][contenthash:8].css'`ã€‚

css æ–‡ä»¶ä¸ºä»€ä¹ˆä¸ç”¨ chunkhashï¼Ÿ

js ä½¿ç”¨çš„æ˜¯ chunkhashï¼Œå¦‚æœ js æ¨¡å—å‘ç”Ÿæ”¹å˜ï¼Œåˆ™ chunkhash ä¹Ÿä¼šæ”¹å˜ï¼Œå¯¼è‡´å®ƒå¼•å…¥çš„ css æ¨¡å—çš„ chunkhash ä¹Ÿè·Ÿç€æ”¹å˜ã€‚

ä½†è¿™æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸º css æ–‡ä»¶æœ¬èº«çš„å†…å®¹å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚

å› æ­¤ css ä½¿ç”¨ contenthashï¼Œåªä¸å…¶è‡ªèº«å†…å®¹æœ‰å…³ï¼Œæ— è§†è¢«å“ªä¸ª js æ¨¡å—å¼•ç”¨ã€‚

3. Images/Fonts çš„æŒ‡çº¹è®¾ç½® `'[name][hash:8].[ext]'`ã€‚

æ³¨æ„ï¼Œå›¾ç‰‡å­—ä½“çš„ hashï¼Œå’Œ cssã€js çš„ hash æ¦‚å¿µä¸åŒï¼Œæ˜¯æŒ‰å†…å®¹ç”Ÿæˆçš„ï¼Œä¸æ˜¯æŒ‰ç¼–è¯‘ç”Ÿæˆçš„ã€‚
:::